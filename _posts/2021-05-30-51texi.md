---
layout: article
title: å¾®æœºè¯¾ç¨‹è®¾è®¡ï¼šç”¨æ±‡ç¼–å†™ä¸€ä¸ªè®¡è´¹å™¨
tags: [é¡¹ç›®, å•ç‰‡æœº]
author: Todd Zhou
license: false
show_author_profile: true
mathjax: false
mermaid: true
chart: false
mathjax_autoNumber: false
mode: normal
key: 2021-05-30-51texi
pageview: true
comment: true
show_edit_on_github: false
show_date: true
aside:
  toc: true
---

å†æ¬¡äº«å—æ“çºµæ‰€æœ‰å¯„å­˜å™¨çš„å¿«æ„Ÿ~

<!--more-->
<!-- more -->

<details>
{% highlight c linenos %}
{% endhighlight %}
</details>


# ç®€ä»‹

&emsp;&emsp;æ²¡é”™ï¼Œæˆ‘åˆè¦å†™ä¸€æ¬¡è¿™ä¸ªç©æ„äº†ï¼Œä¸ºä»€ä¹ˆå‘¢ï¼Ÿå› ä¸ºè®¡ç®—æœºå­¦é™¢å¹¶ä¸è®¤ç”µä¿¡å­¦é™¢çš„å¾®æœºï¼Œæ‰€ä»¥æˆ‘ä¸å¾—ä¸å†å­¦äº†ä¸€æ¬¡ 8051ã€‚ä¸å¾—ä¸è¯´ï¼Œè®¡ç®—æœºå­¦é™¢è®²å¾—æ¸…æ¥šæ˜“æ‡‚å¤šäº†ï¼Œå› ä¸ºç”µä¿¡å­¦é™¢æ˜¯ 8086+8051 ä¸€èµ·æ•™çš„ï¼ˆç”µä¿¡çš„è¯¾ç¨‹è®¾ç½®å¾—çœŸä¸åˆç†ğŸ™ƒï¼‰

&emsp;&emsp;æ¥è¯´è¯´è¦æ±‚å§ï¼è¦æ±‚å¦‚ä¸‹ï¼š

1. ç”¨Proteusè®¾è®¡åŸç†å›¾ï¼Œè¦æ±‚æ˜¾ç¤ºå‡º **é‡Œç¨‹**ï¼Œ**é€Ÿåº¦**ï¼Œ**æ€»ä»·**
2. ä½¿ç”¨ä¸€ä¸ªæŒ‰é’®ï¼ŒæŒ‰ä¸‹æŒ‰é’®å¼€å§‹è®¡è´¹ï¼Œæ¾å¼€æŒ‰é’®åœæ­¢è®¡è´¹
3. ç”¨ä¿¡å·å‘ç”Ÿå™¨æ¥äº§ç”Ÿå‡ºç§Ÿè½¦çš„æ¨¡æ‹Ÿä¿¡å·ï¼ˆè½®å­è½¬ä¸€åœˆäº§ç”Ÿä¸€ä¸ªè„‰å†²ï¼‰
4. å‡ºç§Ÿè½¦è½®èƒå‘¨é•¿æŒ‰ 1.83 ç±³è®¡ç®—ã€‚2 å…¬é‡Œä»¥å†…æŒ‰ 8 å…ƒè®¡ç®—ï¼Œè¶…è¿‡ 2 å…¬é‡Œæ¯å…¬é‡ŒæŒ‰ 2.6 å…ƒè®¡ç®—ã€‚ä¸è€ƒè™‘å…¶ä»–è´¹ç”¨

&emsp;&emsp;è¿™ä¸æ˜¯å¾ˆç®€å•å˜›ï¼Œå¼„ä¸€ä¸ªå¤–éƒ¨ä¸­æ–­æ¥ç»Ÿè®¡è„‰å†²çš„æ¬¡æ•°ï¼Œä»è€Œç®—å‡ºé‡Œç¨‹å’Œä»·æ ¼ï¼Œç„¶åå†å¼„ä¸€ä¸ªè®¡æ—¶å™¨æ¥è®¡ç®—ä¸¤æ¬¡è„‰å†²çš„æ—¶é—´ï¼Œä»è€Œç®—å‡ºé€Ÿåº¦ï¼Œæå®šï¼æœ‰ä¸¤ç‚¹è¦æ³¨æ„ï¼š

* è®¡ç®—ä»·æ ¼æ—¶è¦åˆ¤æ–­æ˜¯å¦å¤§äº 0ï¼Œå†åˆ¤æ–­æ˜¯å¦å¤§äº 2
* è®¡ç®—é€Ÿåº¦æ—¶ï¼Œè¦æ³¨æ„å½“å¤ªä¹…æ²¡è„‰å†²æ—¶ï¼Œè¦é™ä½é€Ÿåº¦

&emsp;&emsp;è¿™ä¸ªç¨‹åºçš„éš¾ç‚¹åœ¨äºæ•°å­¦è®¡ç®—ã€‚

# ç¨‹åºè®¾è®¡

è¿™ä¸ªç¨‹åºåˆ†ä¸ºå››éƒ¨åˆ†ï¼š

* ä¸»ç¨‹åºï¼š
  * åˆ¤æ–­æŒ‰é”®æ˜¯å¦æŒ‰ä¸‹
  * è®¡ç®—é‡Œç¨‹ã€é€Ÿåº¦ã€æ€»ä»·
* å®šæ—¶å™¨0ï¼š
  * è®¡æ—¶
* å®šæ—¶å™¨1ï¼š
  * æ˜¾ç¤º
* å¤–éƒ¨ä¸­æ–­0ï¼š
  * è„‰å†²

ä¸»è¦éœ€è¦å¦‚ä¸‹å¸¸é‡å’Œå˜é‡ï¼š

* å¸¸é‡ï¼š
  * n å…¬é‡Œ `MILE_THRESHOLD`
  * èµ·æ­¥ä»· `START_PRICE`
  * n å…¬é‡Œåæ¯å…¬é‡Œä»·æ ¼ `MILE_PRICE_INT` å’Œ `MILE_PRICE_DEC`
  * è½®èƒå‘¨é•¿ `WHEEL_C_INT` å’Œ `WHEEL_C_DEC`
  * æ•°ç ç®¡æ˜¾ç¤ºç  `LED_DIGIT_CODE`
* å˜é‡
  * ä¸Šä¸ªè„‰å†²çš„æ—¶é—´ `last_pulse`ã€`tast_pulse_tl0`ã€`tast_pulse_th0`
  * å½“å‰è„‰å†²çš„æ—¶é—´ `this_pulse`
  * æ€»è„‰å†²æ¬¡æ•° `total_pulse_h` å’Œ `total_pulse_l`
  * é€Ÿåº¦ `speed_int` å’Œ `speed_dec`
  * ä»·æ ¼ `price_int` å’Œ `price_dec`
  * é‡Œç¨‹ `mile_int` å’Œ `mile_dec`
  * æ¯ä¸ªæ•°ç ç®¡çš„æ•°å­— `digit0~11`

## æ•°å­¦ç›¸å…³

&emsp;&emsp;æ­¤å¤„æˆ‘ä»¬å°†è®¨è®ºå°æ•°çš„è¡¨ç¤ºã€å˜é‡çš„èŒƒå›´ä»¥åŠç²¾ç¡®åº¦ã€å®šæ—¶æ—¶é—´ã€å®šç‚¹å°æ•°çš„è®¡ç®—ä¸è½¬æ¢ã€‚

### å°æ•°çš„è¡¨ç¤º

&emsp;&emsp;å°æ•°æœ‰ä¸¤ç§è¡¨ç¤ºæ–¹æ³•ï¼šå®šç‚¹ä¸æµ®ç‚¹ï¼Œå®šç‚¹çš„å¥½å¤„å°±æ˜¯æ–¹ä¾¿ç®—ï¼Œä½†è´¹ç©ºé—´ï¼›æµ®ç‚¹çš„å¥½å¤„å°±æ˜¯çœç©ºé—´ï¼Œä½†éš¾ç®—ã€‚ä½œä¸ºä¸€ä¸ªæ‡’äººï¼Œæˆ‘å†³å®šä½¿ç”¨å®šç‚¹ï¼Œåç»­æˆ‘å°†â€œ2bytes æ•´æ•°+1bytes å°æ•°â€ç®€å†™ä¸ºâ€œ2+1â€ï¼Œ1+1ã€2+2 ä¹Ÿæ˜¯ç±»ä¼¼çš„ã€‚

### å˜é‡çš„è¡¨ç¤ºä¸è®¡ç®—

&emsp;&emsp;**å˜é‡çš„èŒƒå›´ä¸ç²¾ç¡®åº¦**ã€‚

* ä»ç¡¬ä»¶ä¸Šæ¥åˆ†æï¼šæ¯ä¸ªæ•°ç ç®¡éƒ½æ˜¯ 4 ä½ï¼Œæ‰€ä»¥æŒ‰é“ç†æ¯ä¸ªå˜é‡éƒ½è‡³å°‘éœ€è¦ 2+1ï¼Œç”šè‡³ 2+2. ä¸€äº›ä¸­é—´å˜é‡ï¼Œå¦‚è„‰å†²æ€»æ•°éœ€è¦æ›´å¤š
* ä»å¸¸è¯†ä¸Šåˆ†æï¼šé«˜é€Ÿçš„é€Ÿåº¦ä¸ä¼šè¶… 200 km/hï¼Œæ‰€ä»¥ 1+1 å¤Ÿç”¨ï¼›å¸‚åŒºå‡ºç§Ÿè½¦è·¯ç¨‹å¾ˆå°‘è¶… 100kmï¼ŒåŒæ ·åªéœ€è¦ 1+1ï¼›ä»·æ ¼æœ€å¤§å¯èƒ½ä¸º $100\times 5=500$ï¼ˆä¸Šæµ·å¸‚å¤œé—´è¶…è¿‡ 15km ä¸º 4.7ï¿¥/kmï¼‰ï¼Œæ‰€ä»¥éœ€è¦ 2+1
* ä»è€å¸ˆç»™çš„ç¤ºä¾‹åˆ†æï¼šç¤ºä¾‹ä¸­ï¼Œå—å°æ•°ç‚¹çš„é™åˆ¶ï¼Œä»·æ ¼å’Œé‡Œç¨‹å‡ä¸è¿‡ç™¾ï¼Œ1+1 å¤Ÿç”¨ã€‚é€Ÿåº¦å€’æ˜¯æœ‰å»åˆ° 250 çš„ï¼Œéœ€è¦ 2+1.

&emsp;&emsp;ä½œä¸ºä¸€ä¸ªæ‡’äººï¼Œæˆ‘è§‰å¾—å¤Ÿç”¨å°±è¡Œï¼Œå› æ­¤ä½¿ç”¨ç¬¬ä¸‰ç§ï¼Œå³ä»·æ ¼ã€é‡Œç¨‹ä¸º 1+1ï¼Œé€Ÿåº¦ä¸º 2+1ã€‚ï¼ˆæ³¨ï¼šå®é™…ä»£ç ä¸­ï¼Œä¸ºäº†æ–¹ä¾¿é™¤æ³•è¿ç®—ï¼Œé€Ÿåº¦ã€é‡Œç¨‹å‡ä½¿ç”¨ 3+1ï¼‰

&emsp;&emsp;å“¦ï¼Œå¯¹äº†ï¼Œ1 Byte å°æ•°çš„æœ€å°ç²¾ç¡®åˆ° $0.00390625$ï¼Œè¶³å¤Ÿäº†ï¼Œæ¯•ç«Ÿç°åœ¨ä¹Ÿæ²¡æœ‰äººç»™é’±ä¼šç²¾ç¡®åˆ°å˜ã€‚

---

&emsp;&emsp;**å®šæ—¶æ—¶é—´**ã€‚æ•°ç ç®¡æ˜¾ç¤ºçš„å®šæ—¶é‡‡ç”¨è‡ªåŠ¨è£…å…¥ï¼Œå®šæ—¶æ—¶é—´å– 8 ä½å®šæ—¶å™¨æ‰€èƒ½è¾¾åˆ°çš„æœ€å¤§å€¼ï¼ˆåæ­£è¿™åˆ·æ–°ç‡å·²ç»å¤Ÿç”¨äº†ï¼‰ï¼Œåˆå€¼ä¸º 0. 

&emsp;&emsp;è‡³äºè®¡æ—¶å˜›ï¼Œè¿™å°±è¦è®¨è®ºä¸€ä¸‹äº†ã€‚è®¡æ—¶ä¸»è¦ç”¨äºè®¡ç®—ä¸¤ä¸ªè„‰å†²ä¹‹é—´é—´éš”çš„æ—¶é—´ï¼Œæ€ä¹ˆè®¡å‘¢ï¼Ÿæ­¥éª¤å¦‚ä¸‹ï¼š

1. å½“æœ‰è„‰å†²æ¥æ—¶ï¼Œè¯»å–å®šæ—¶å™¨çš„æ•°å€¼ï¼Œç„¶åæ¸…é›¶ï¼Œå¼€å§‹å¯¹ä¸‹ä¸€ä¸ªè„‰å†²è®¡æ—¶ã€‚
2. å¦‚æœå®šæ—¶å™¨åˆ°æ—¶é—´åè¿˜æ²¡æœ‰è„‰å†²ï¼Œå°±ç»™å˜é‡ `this_pulse` åŠ ä¸€ï¼ˆç›¸å½“äºæ‰©å±•äº†å®šæ—¶å™¨çš„ä½ï¼‰ã€‚
3. æœ€ç»ˆè®¡ç®—çš„æ—¶é—´åŒ…æ‹¬å®šæ—¶å™¨çš„æ—¶é—´ï¼ˆä½2bytesï¼‰å’Œ `this_pulse`ï¼ˆé«˜tyteï¼‰ã€‚
4. ä¸‹ä¸€ä¸ªè„‰å†²æ¥æ—¶é‡å¤ 1~3

&emsp;&emsp;è¿™ç§æ–¹æ³•çš„å¥½å¤„æ˜¯ï¼šç²¾ç¡®ï¼Œå¹¶ä¸”è§¦å‘ä¸­æ–­çš„æ¬¡æ•°ä¹Ÿå°‘å¾ˆå¤šã€‚ç¼ºç‚¹å°±æ˜¯ï¼šæˆ‘ä»¬æœ€åå¾—å‡ºçš„æ—¶é—´æ˜¯ 3 bytesï¼Œè®¡ç®—å¯èƒ½ä¼šæ¯”è¾ƒå¤æ‚ã€‚

&emsp;&emsp;3 bytes å¤Ÿä¸å¤Ÿç”¨å‘¢ï¼Ÿå‡è®¾é€Ÿåº¦ä¸º $v$ï¼Œè½®èƒå‘¨é•¿ä¸º $C$ï¼Œæœºå™¨å‘¨æœŸä¸º $t_0$ï¼Œé‚£ä¹ˆå®šæ—¶å™¨çš„æ•°å€¼ä¸ºï¼ˆè€ƒè™‘ä¸Šæ‰©å±•ä½ï¼‰ï¼š$t=\dfrac{C}{vt_0}$ã€‚å– $t_0=1{\rm \mu s}$ï¼Œ$C=1.83 {\rm m}$ã€‚é‚£ä¹ˆ $v=100 {\rm km/h}$ æ—¶ï¼Œ$t=65880$ï¼›$v=1 {\rm km/h}$ æ—¶ï¼Œ$t=6588000$ï¼›è¿™ä¸¤ä¸ªæ•°è½¬ä¸ºäºŒè¿›åˆ¶åå‡ä¸è¶…å‡º 3 ä¸ªå­—èŠ‚ï¼ˆ24ä½ï¼‰ï¼Œå¦‚æœä¾ç„¶æº¢å‡ºï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥è®¤ä¸ºé€Ÿåº¦ä¸º 0.

```
DEC 6588000
BIN 0110 0100 1000 0110 0110 0000
```

&emsp;&emsp;**é€Ÿåº¦è®¡ç®—**ã€‚ä½†æ­¤å¤„åˆæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œè¿™ä¹ˆé•¿çš„æ•°æ€ä¹ˆè®¡ç®—å•Šã€‚é¦–å…ˆå…ˆç¡®å®šå…¬å¼ï¼š$v=\dfrac{C}{t}$ã€‚è€ƒè™‘å•ä½è½¬æ¢ï¼Œ${\rm \dfrac{m}{\mu s}}\cdot k={\rm km/h}$ï¼Œç®—å‡º $k=3.6 \times 10^{6}$ï¼Œå³æˆ‘ä»¬æœ€åè¦ä¹˜ä¸Šè¿™ä¸ªæ•°ã€‚è¿™ä¸ªæ•°å¤ªå¤§äº†ï¼Œæˆ‘ä»¬å°†å®ƒåˆ†è§£ä¸º $28125 \times 2^7$ï¼Œè¿™ä¹ˆä¸€æ¥ï¼Œå…¬å¼å°±å˜ä¸ºï¼š

$$
\begin{aligned}
  v&=\dfrac{C}{t}\cdot 28125 \times 2^7\\
  &=\dfrac{C\gg 1}{t}\cdot 28125 \times 2^8\\
  &=\dfrac{C\gg 1}{t \gg 8} \cdot 28125\\
  &=\dfrac{(C\cdot 28125)\gg 1}{t \gg 8}
\end{aligned}\\
vï¼šé€Ÿåº¦ \; Cï¼šå‘¨é•¿ \; tï¼šæ—¶é—´é—´éš”
$$

&emsp;&emsp;$C$ æ˜¯ä¸€ä¸ª 1+1 çš„æ•°ï¼Œ$t$ ç§»ä½ï¼ˆæ³¨ï¼šè¿™å¹¶ä¸æ˜¯çœŸçš„ç§»ä½ï¼Œè€Œæ˜¯æŠŠä½ 8 ä½ç§»ä½œå°æ•°ï¼‰åæ˜¯ä¸€ä¸ª 2+1 çš„æ•°ï¼Œ28125 æ˜¯ä¸€ä¸ª 2+0 çš„æ•°ã€‚æˆ‘ä»¬ç”šè‡³å¯ä»¥å†è¿›ä¸€æ­¥ç®€åŒ–ï¼Œæ¯”å¦‚ 28125 å¯ä»¥æ¢ä¸º 28160ï¼ˆå³ 6E00Hï¼‰ï¼Œè¿™ä»…ä¼šå¸¦æ¥ 0.124% çš„è¯¯å·®ï¼Œä½†æ›¿æ¢åï¼Œä½ 8 ä½å°±å˜ä¸ºäº† 0ï¼Œæˆ‘ä»¬å°±æ— éœ€è®¡ç®—ä½ 8 ä½ç›¸ä¹˜ã€‚

&emsp;&emsp;æˆ‘ä»¬å…ˆæ¥è®¡ç®— C ä¸ 28125 ç›¸ä¹˜ã€‚è¿™æ˜¯ä¸ªå›ºå®šçš„æ•°ï¼Œæ‰€ä»¥åªéœ€è¦è®¡ç®—ä¸€æ¬¡ã€‚

$$
(C_H+C_L\times 2^{-8})\times {\rm 6E00H}\\
=(C_H \times {\rm 6EH})\ll8+(C_L\times {\rm 6EH})
$$

&emsp;&emsp;ä¸Šé¢çš„ç»“æœæ˜¯ä¸€ä¸ª 3+1 çš„æ•°ï¼Œç„¶åæˆ‘ä»¬å†ç®—é™¤æ³•ï¼Œæ­¤å¤„æˆ‘ä»¬å¿½ç•¥ $t$ çš„å°æ•°éƒ¨åˆ†ï¼Œè¿™æ ·çš„è¯åœ¨ 100 km/h æ—¶ä»…å¸¦æ¥ 0.3% çš„è¯¯å·®ï¼Œä½é€Ÿæ—¶è¯¯å·®ä¼šæ›´å°ï¼ˆå› ä¸ºä½é€Ÿæ—¶ $t$ ä¼šæ›´å¤§ï¼‰ã€‚è¿™ä¹ˆä¸€æ¥ï¼Œæˆ‘ä»¬åªéœ€è¦ç®—ä¸€ä¸ª 3+1 å­—èŠ‚é™¤ä»¥ 2 å­—èŠ‚ã€‚å¤šå­—èŠ‚é™¤æ³•çš„å…·ä½“è®¡ç®—è¿‡ç¨‹æˆ‘ä»¬åé¢ä¸€èµ·è®¨è®ºã€‚


&emsp;&emsp;**é‡Œç¨‹è®¡ç®—** è½®èƒå‘¨é•¿ 1.83mï¼Œé‚£ä¹ˆèµ° 1km å°±ä¼šæœ‰ 546 ä¸ªè„‰å†²ï¼Œ100km å°±ä¼šæœ‰ 54645 ä¸ªè„‰å†²ï¼Œå› æ­¤æˆ‘ä»¬ç”¨ 2 ä¸ªå­—èŠ‚æ¥å­˜å‚¨è„‰å†²æ•°ã€‚é‚£ä¹ˆï¼Œæ€»é‡Œç¨‹ç­‰äºè„‰å†²æ•°Ã—å‘¨é•¿Ã·1000. è„‰å†²æ•°Ã—å‘¨é•¿å¾—åˆ°å¾—æ˜¯ä¸€ä¸ª 3+1 çš„æ•°ï¼Œ1000 æ˜¯ 2 å­—èŠ‚çš„æ•°ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæ­¤å¤„éœ€è¦è®¡ç®—ä¸€ä¸ª 3+1 å­—èŠ‚é™¤ä»¥ 2 å­—èŠ‚ã€‚

&emsp;&emsp;**ä»·æ ¼è®¡ç®—** å…ˆåˆ©ç”¨ç›¸å‡æ¥æ¯”è¾ƒå¤§å°ï¼Œä½äºä¸€å®šä»·æ ¼å°±æŒ‰èµ·æ­¥ä»·æ¥ç®—ï¼Œé«˜äºä¸€å®šä»·æ ¼ï¼Œå°±ç›´æ¥ç”¨ç›¸å‡çš„ç»“æœä¹˜ä¸Šæ¯å…¬é‡Œçš„ä»·æ ¼ï¼Œç„¶åå†åŠ ä¸Šèµ·æ­¥ä»·å³å¯ã€‚å¤šå­—èŠ‚ä¹˜æ³•ä¸€ç‚¹éš¾åº¦éƒ½æ²¡æœ‰ã€‚

&emsp;&emsp;**3+1 å­—èŠ‚é™¤ä»¥ 2 å­—èŠ‚** å‚è€ƒ [51å•ç‰‡æœºå¤šå­—èŠ‚é™¤æ³•](http://blog.sina.com.cn/s/blog_67d570860102vl44.html)ï¼Œå¤šå­—èŠ‚é™¤æ³•æœ‰ä¸¤ç§ï¼šç§»ä½ç›¸å‡å’Œå¾ªç¯ç›¸å‡ã€‚

* å¾ªç¯ç›¸å‡ï¼šå¾ªç¯ç›¸å‡çš„åŸç†å°±æ˜¯ç”¨è¢«é™¤æ•°å‡å»é™¤æ•°ï¼Œåˆ¤æ–­æ˜¯ä¸æ˜¯å¤Ÿå‡ï¼Œå¦‚æœå¤Ÿå‡ï¼Œå°†è¢«é™¤æ•°æ•°æ›´æ–°ä¸ºå·®å€¼ï¼Œå•†åŠ 1ï¼›å¦‚æœä¸å¤Ÿå‡ï¼Œåˆ™ç»“æŸï¼Œæ­¤æ—¶çš„è¢«é™¤æ•°å³ä¸ºä½™æ•°ã€‚å…¶å®è´¨å°±æ˜¯ï¼Œæ±‚å‡ºè¢«é™¤æ•°ä¸­æœ‰å¤šå°‘ä¸ªé™¤æ•°ã€‚ï¼ˆè¿™ç§æ–¹æ³•å¾ˆè ¢ï¼‰
* ç§»ä½ç›¸å‡ï¼šå°±å’Œäººæ‰‹ç®—çš„åŸç†ç±»ä¼¼ï¼Œæ¯”å¦‚ç®— 1011 é™¤ä»¥ 11
  1. 1 - 11 ä¸å¤Ÿå‡ï¼Œæ‰€ä»¥ç»“æœæœ€é«˜ä½ä¸º 0
  2. 10 - 11 ä¸å¤Ÿå‡ï¼Œæ‰€ä»¥ç»“æœç¬¬äºŒä½ä¸º 0
  3. 101 - 11 = 10ï¼Œæ‰€ä»¥ç»“æœç¬¬ä¸‰ä½ä¸º 1
  4. 101 - 11 = 10ï¼Œæ‰€ä»¥ç»“æœç¬¬å››ä½ä¸º 1
  5. å¦‚æœä¸éœ€è¦ç®—å°æ•°ï¼Œé‚£ä¹ˆç»“æœå°±æ˜¯ 0011 ä½™ 10ï¼›å¦‚æœè¦ç®—å°æ•°ï¼Œé‚£ä¹ˆé‡å¤ä¸Šé¢æ­¥éª¤ç»§ç»­ç®—ä¸‹å»

&emsp;&emsp;å…·ä½“ç¨‹åºåœ¨åé¢éƒ¨åˆ†ã€‚


## ç¨‹åºé€»è¾‘

&emsp;&emsp;è¿™é‡Œç”¨â€œä¼ªâ€ä¼ªä»£ç æè¿°ä¸€ä¸‹ç¨‹åºé€»è¾‘ï¼š

```c
ä¸»ç¨‹åº:
    è®¡ç®—é€Ÿåº¦
    åˆ¤æ–­æŒ‰é’®
    if æœªæŒ‰ä¸‹:
        åœæ­¢è®¡ç®—è·¯ç¨‹å’Œä»·æ ¼ï¼ˆä¿æŒæ˜¾ç¤ºçš„æ•°å­—ä¸å˜ï¼‰
    else:
        if æ­£åœ¨è®¡æ—¶ï¼š
            è®¡ç®—è·¯ç¨‹å’Œä»·æ ¼
            è½¬åŒ–ä¸ºBCD
        else:
            æ¸…é›¶
            è®¡ç®—è·¯ç¨‹å’Œä»·æ ¼
            è½¬åŒ–ä¸ºBCD


è®¡æ—¶ï¼ˆå®šæ—¶å™¨0ï¼‰:
    å¼€å§‹ä¸‹æ¬¡è®¡æ—¶
    this_pulse++ ï¼ˆæœ¬æ¬¡é—´éš”çš„æº¢å‡ºæ¬¡æ•°åŠ ä¸€ï¼‰
    if this_pulse>last_pulse:
        last_pulse = this_pulse + 10 //10 ä¸ºé€Ÿåº¦çš„åˆ·æ–°é—´éš”ï¼Œå¯å˜

æ˜¾ç¤ºï¼ˆå®šæ—¶å™¨1ï¼‰:
    æ ¹æ®BCDæ¥æ˜¾ç¤º

è„‰å†²ï¼ˆå¤–éƒ¨ä¸­æ–­0ï¼‰:
    æš‚åœå®šæ—¶å™¨0
    ä¿å­˜å®šæ—¶å™¨0
    ä¿å­˜ this_pulse åˆ° last_pulse
    æ¸…é›¶å®šæ—¶å™¨0
    å¼€å¯å®šæ—¶å™¨0
    total_pulse++
```

&emsp;&emsp;é‡Œç¨‹ã€ä»·æ ¼éƒ½æ²¡ä»€ä¹ˆé—®é¢˜ï¼Œä½†æ˜¯é€Ÿåº¦å¯èƒ½ä¼šæœ‰ Bug. ä¸‹é¢æ¥åˆ†æä¸€ä¸‹ã€‚

&emsp;&emsp;å‡å¦‚è„‰å†²ï¼ˆå¤–éƒ¨ä¸­æ–­0ï¼‰çš„ä¼˜å…ˆçº§æœ€é«˜ï¼Œæ˜¾ç¤ºå’Œè®¡æ—¶çš„ä¼˜å…ˆçº§è¾ƒä½ã€‚é‚£ä¹ˆï¼Œè„‰å†²ä¸­æ–­å°±æœ‰å¯èƒ½æ‰“æ–­è®¡æ—¶ä¸­æ–­ï¼Œæ¯”å¦‚ï¼š

```c
è®¡æ—¶ï¼š
    å¼€å§‹ä¸‹æ¬¡è®¡æ—¶
        //æ­¤æ—¶æœ‰è„‰å†²
        //this_pulse è¿˜æ²¡ +1 å°±è¢«ä¿å­˜
        //å®šæ—¶å™¨0è¢«æ¸…é›¶
        //å¼€å§‹ä¸‹æ¬¡è®¡æ—¶
    this_pulse++ //å®šæ—¶å™¨0æ¸…é›¶åå¤šåŠ äº† 1
    ...
```

&emsp;&emsp;é‚£ä¹ˆè¦å¦‚ä½•ä¿®å¤è¿™ä¸ª bug å‘¢ï¼Ÿå”¯ä¸€çš„æ–¹æ³•æ˜¯åœ¨å¤–éƒ¨ä¸­æ–­ 0 ä¸­åˆ¤æ–­å®šæ—¶å™¨ 0 æœ‰æ— è§¦å‘ä¸­æ–­ï¼ˆå³åˆ¤æ–­æœ‰æ— æ‰“æ–­è®¡æ—¶ä¸­æ–­ï¼‰ï¼Œä½† TF0 å·²ç»è¢«ç¡¬ä»¶è‡ªåŠ¨æ¸… 0 äº†ï¼Œæ‰€ä»¥æ— æ³•å®ç°ï¼ˆæˆ–è€…è¯´æˆ‘æƒ³ä¸åˆ°æ–¹æ³•å®ç°ï¼‰ã€‚æˆ‘ä»¬åªèƒ½å°†å¤–éƒ¨ä¸­æ–­ 0 å’Œå®šæ—¶å™¨ 0 çš„ä¼˜å…ˆçº§å‡è®¾ä¸ºæœ€é«˜ï¼Œè¿™æ ·è™½ç„¶ä¸èƒ½åŠæ—¶å“åº”å¤–éƒ¨ä¸­æ–­ï¼Œä½†è¿™æ ·å¸¦æ¥çš„è¯¯å·®åªæœ‰å‡ ä¸ªæœºå™¨å‘¨æœŸè€Œå·²ï¼Œå¯ä»¥æ¥å—ã€‚

# ç¨‹åºç¼–å†™

![åŸç†å›¾](https://i.loli.net/2021/06/22/sQ3dcFSM9eH7Xl2.jpg)

æ³¨ï¼š

* å‡¡æ˜¯ä¸è®¡ç®—ç›¸å…³çš„ï¼Œéƒ½æ”¾åœ¨ä¸»å¾ªç¯ä¸­åšï¼Œæ‰€ä»¥è¿™éƒ¨åˆ†å‡½æ•°ä¸éœ€è¦ push Acc å’Œ push PSWã€‚è€Œä¸­æ–­åˆ™æœ‰å¯èƒ½æ‰“æ–­è®¡ç®—è¿‡ç¨‹ï¼Œæ‰€ä»¥éœ€è¦ push Acc å’Œ PSW
* ç¨‹åºæœ‰äº›ç»†èŠ‚ä¸ä¸Šé¢è®¨è®ºçš„ç•¥æœ‰å‡ºå…¥

## å¸¸é‡ä¸å˜é‡

<details>
{% highlight c linenos %}
;====================================================================
; DEFINITIONS
;====================================================================

MILE_THRESHOLD EQU 2H
START_PRICE EQU 8H
MILE_PRICE_INT EQU 2H
MILE_PRICE_DEC EQU 99H
WHEEL_C_INT EQU 1H
WHEEL_C_DEC EQU 0D4H

;====================================================================
; VARIABLES
;====================================================================

; Pulse Interval
last_pulse_tl0 EQU 30H
last_pulse_th0 EQU 31H
last_pulse EQU 32H
this_pulse EQU 33H

; Total Number of Pulses
total_pulse_l EQU 34H
total_pulse_h EQU 35H

; Speed
speed_dec EQU 36H
speed_int_l EQU 37H
speed_int_m EQU 38H
speed_int_h EQU 39H


; Price
price_dec EQU 40H
price_int EQU 41H

; Mile
mile_dec EQU 42H
mile_int_l EQU 43H
mile_int_m EQU 44H
mile_int_h EQU 45H

; km
mile_km_l EQU 46H
mile_km_h EQU 47H

; Divide Calculation
c_bit EQU 06H
c_stack_bit EQU 07H
remainder_l EQU 58H
remainder_h EQU 59H

; Display
digit_dot EQU 20H
digit_price_dot_0 EQU 00H
digit_price_dot_1 EQU 01H
digit_mile_dot_0 EQU 02H
digit_mile_dot_1 EQU 03H
digit_speed_dot_0 EQU 04H
digit_speed_dot_1 EQU 05H
;c_bit EQU 06H
zero_speed_bit EQU 07H
digit_price_l EQU  5AH
digit_price_h EQU 5BH
digit_mile_l EQU 5CH
digit_mile_h EQU 5DH
digit_speed_l EQU 5EH
digit_speed_h EQU 5FH

; Run Bit
run_bit EQU 08H
{% endhighlight %}
</details>

## åˆå§‹åŒ–ä¸ä¸»å‡½æ•°

<details>
{% highlight c linenos %}
;====================================================================
; RESET and INTERRUPT VECTORS
;====================================================================

    ; Reset Vector
    org   0000H
    jmp   Start

    org   0003H
    clr TR0 ;ä¸ºæé«˜å‡†ç¡®ç‡ï¼Œå…ˆæš‚åœå†è·³è½¬ ;1MC
    ljmp   Pulse ;2MC

    org   000BH
    setb  TR0
    ljmp  Timer

    org   001Bh
    ljmp  Display

;====================================================================
; CODE SEGMENT
;====================================================================

    org   0100h

LED_SEGMENT_CODE:
    db 3FH, 06H, 5BH, 4FH, 66H, 6DH, 7DH, 07H, 7FH, 6FH ;æ•°ç ç®¡0~9

Start:
    mov SP, #5FH
    mov IP, #00000011B
    setb ET0
    setb EX0
    setb IT0
    lcall Display_Test
    setb TR0
Loop:
    lcall Calc_Speed ;æ— è®ºæœ‰æ— æŒ‰ä¸‹æŒ‰é”®ï¼Œå‡æ˜¾ç¤ºé€Ÿåº¦
    lcall Bin2BCD ;è½¬åŒ–ä¸ºBCDï¼Œç”¨äºæ˜¾ç¤º
    jnb P3.7, Button_Not_Pressed ;æŒ‰é”®æ²¡æœ‰æŒ‰ä¸‹
    jb run_bit, Button_Pressed ;æŒ‰é”®æŒ‰ä¸‹ï¼Œä¸”ä¸Šä¸€æ—¶åˆ»ä¹ŸæŒ‰ä¸‹
    ;æŒ‰é”®ä»æœªæŒ‰ä¸‹åˆ°æŒ‰ä¸‹ï¼Œæ¸…é›¶é‡Œç¨‹ï¼Œå¹¶å¼€å§‹è®¡è´¹
    mov total_pulse_l, #0
    mov total_pulse_h, #0
    setb run_bit ;è®¾ç½®run_bit
    Button_Pressed:
        lcall Calc_Mile ;è®¡ç®—é‡Œç¨‹
        lcall Calc_Price ;è®¡ç®—ä»·æ ¼
        jmp Loop
    Button_Not_Pressed:
        clr run_bit ;æ¸…é™¤ run_bit
        jmp Loop ;å½“å‰å€¼ä¸å˜ï¼Œç›´æ¥å¾ªç¯
{% endhighlight %}
</details>

## è®¡ç®—

### é™¤æ³•


<details>
{% highlight c linenos %}
DIV_4_BY_2:
    ;R0 å­˜ 4 å­—èŠ‚è¢«é™¤æ•°çš„ä½ä½åœ°å€ï¼ˆå°ç«¯ï¼‰
    ;R1 å­˜ 2 å­—èŠ‚é™¤æ•°çš„ä½ä½åœ°å€ï¼ˆå°ç«¯ï¼‰
    ;ç»“æœä¼šä¿å­˜åˆ°è¢«é™¤æ•°çš„ 3 ä¸ªå­—èŠ‚ä¸­
    ;éœ€è¦ç»™ remainder_l, remainder_h, c_bit åˆ†é…ç©ºé—´
    ;æˆ–è€…å¯ä»¥ç”¨ remainder_h EQU R3
    mov B, #32 ;å¾ªç¯æ¬¡æ•° ;4*8
    mov remainder_h, #0
    mov remainder_l, #0
    DIV_RLC:
        clr C ;æ¸…ç©º Cï¼Œä½¿å¾—å¾ªç¯ç§»ä½æ—¶æœ€ä½ä½ç§»å…¥çš„æ˜¯ 0

        ;å°†è¢«é™¤æ•°å·¦ç§»
        mov A, @R0 ;å–æœ€ä½ä½
        rlc A ;å¾ªç¯å·¦ç§»
        mov @R0, A ;ä¿å­˜æœ€ä½ä½

        inc R0 
        mov A, @R0 ;å–ä¸­é—´ä½
        rlc A ;å¾ªç¯å·¦ç§»
        mov @R0, A ;ä¿å­˜ä¸­é—´ä½

        inc R0 
        mov A, @R0 ;å–ä¸­é—´ä½
        rlc A ;å¾ªç¯å·¦ç§»
        mov @R0, A ;ä¿å­˜ä¸­é—´ä½

        inc R0
        mov A, @R0 ;å–æœ€é«˜ä½
        rlc A ;å¾ªç¯
        mov @R0, A ;ä¿å­˜æœ€é«˜ä½

        ;æ¢å¤ R0 ä¸ºæœ€ä½ä½
        mov c_bit, C
        dec R0
        dec R0
        dec R0
        mov C, c_bit

        ;æŠŠç§»å‡ºçš„æœ€é«˜ä½æ”¾å…¥ä½™æ•°
        mov A, remainder_l ;å–ä½™æ•°ä½ä½
        rlc A ;å¾ªç¯å·¦ç§»
        mov remainder_l, A;ä¿å­˜ä½ä½

        mov A, remainder_h ;å–ä½™æ•°é«˜ä½
        rlc A ;å¾ªç¯å·¦ç§»
        mov remainder_h, A;ä¿å­˜é«˜ä½

        mov c_bit, C ;ä¿å­˜ä½™æ•°ç§»å‡ºçš„æœ€é«˜ä½

        
    DIV_SUB:
        ;å¤šå­—èŠ‚å‡æ³•
        clr C
        mov A, remainder_l
        subb A, @R1 ;ä½ä½ç›¸å‡
        mov R7, A

        inc R1
        mov A, remainder_h
        subb A, @R1 ;é«˜ä½ç›¸å‡
        mov R6, A
        
        jb c_bit, DIV_INC ;c_bit ä¸º 1ï¼Œè‚¯å®šå¤Ÿå‡ï¼Œä¿å­˜ç›¸å‡åçš„ä½™æ•°
        jc DIV_CONTINUE ;c_bit ä¸º 0ï¼Œä¸” C=1ï¼Œä¸å¤Ÿå‡ï¼Œä¸ä¿å­˜ç›¸å‡çš„ç»“æœ
    DIV_INC:
        mov remainder_l, R7
        mov remainder_h, R6
        inc @R0
    DIV_CONTINUE:
        dec R1 ;æ¢å¤ R1 ä¸ºæœ€ä½ä½
        djnz B, DIV_RLC
        clr C
    DIV_RETURN:
        RET
{% endhighlight %}
</details>

&emsp;&emsp;æ³¨æ„è¿™ä¸ªå‡½æ•°çš„ç»“æœä¼šè¦†ç›–è¢«é™¤æ•°ï¼

### è®¡ç®—ä»·æ ¼

<details>
{% highlight c linenos %}
;====================================================================
; è®¡ç®—ä»·æ ¼
;====================================================================
Calc_Price:
    push Acc
    Calc_Price_If_Zero:
        mov A, mile_int_l
        cjne A, #0, Calc_Price_If
        mov A, mile_dec
        cjne A, #0, Calc_Price_If
        mov price_dec, #0
        mov price_int, #0
        jmp Calc_Price_Return
    Calc_Price_If:
        mov A, mile_int_l
        clr C
        subb A, #MILE_THRESHOLD
        jnc Calc_Price_Larger ;è‹¥é‡Œç¨‹çš„æ•´æ•°éƒ¨åˆ†å¤§äºç­‰äºèµ·æ­¥é‡Œç¨‹åˆ™è·³è½¬
    Calc_Price_Less:
        mov price_dec, #0
        mov price_int, #START_PRICE
        jmp Calc_Price_Return
    Calc_Price_Larger:
        push Acc ;ä¿å­˜ç›¸å‡åçš„ç»“æœ
        ;å¤šå‡ºæ¥çš„æ•´æ•°xæ¯å…¬é‡Œä»·æ ¼çš„å°æ•°éƒ¨åˆ†
        mov B, #MILE_PRICE_DEC
        mul AB 
        mov price_dec, A
        mov price_int, B
        ;å¤šå‡ºæ¥çš„æ•´æ•°xæ¯å…¬é‡Œä»·æ ¼çš„æ•´æ•°éƒ¨åˆ†
        pop Acc
        mov B, #MILE_PRICE_INT
        mul AB
        add A, price_int
        mov price_int, A
        ; TODO: å¤„ç† B!=0 çš„æƒ…å†µ
        mov A, mile_dec
        mov B, #MILE_PRICE_INT
        mul AB
        add A, price_dec
        mov price_dec, A
        mov A, price_int
        addc A, B
        mov price_int, A
        mov A, mile_dec
        mov B, #MILE_PRICE_DEC
        mul AB
        xch A, B
        add A, price_dec
        mov price_dec, A
        mov A, #START_PRICE
        addc A, price_int
        mov price_int, A
    Calc_Price_Return:
        pop Acc
        ret
Calc_Price_Test:
    ; è‹¥ç¨‹åºæ­£ç¡®ï¼Œåº”è¯¥ä¼šæ˜¾ç¤º 11.9 å…ƒ
    lcall Display_Test
    mov mile_int_l, #3
    mov mile_dec, #80H
    lcall Calc_Price
    lcall Bin2BCD
    ret
{% endhighlight %}
</details>

### è®¡ç®—é‡Œç¨‹

<details>
{% highlight c linenos %}
;====================================================================
; è®¡ç®—é‡Œç¨‹
;====================================================================
Calc_Mile:
    push Acc
    Calc_Mile_Mul:
        mov A, #WHEEL_C_DEC
        mov B, total_pulse_l
        mul AB
        mov mile_dec, A
        mov mile_int_l, B
        mov A, #WHEEL_C_INT
        mov B, total_pulse_l
        mul AB
        add A, mile_int_l
        mov mile_int_l, A
        mov A, #0
        addc A, B
        mov mile_int_m, A
        mov A, #WHEEL_C_DEC
        mov B, total_pulse_h
        mul AB
        add A, mile_int_l
        mov mile_int_l, A
        mov A, mile_int_m
        addc A, B
        mov mile_int_m, A
        jnc $+4
        inc mile_int_h
        mov A, #WHEEL_C_INT
        mov B, total_pulse_h
        mul AB
        add A, mile_int_m
        mov mile_int_m, A
        mov A, mile_int_h
        addc A, B
        mov mile_int_h, A
    Calc_Mile_Div:
        mov mile_km_l, #0E8H
        mov mile_km_h, #03H
        mov R0, #mile_dec
        mov R1, #mile_km_l
        acall DIV_4_BY_2
    pop Acc
    ret
Calc_Mile_Test:
    ; å¦‚æœç¨‹åºæ­£ç¡®ï¼Œåº”è¯¥ä¼šæ˜¾ç¤º 1 km
    lcall Display_Test
    mov total_pulse_l, #22H
    mov total_pulse_h, #02H
    lcall Calc_Mile
    lcall Bin2BCD
    ret
{% endhighlight %}
</details>

### è®¡ç®—é€Ÿåº¦

<details>
{% highlight c linenos %}
;====================================================================
; è®¡ç®—é€Ÿåº¦
;====================================================================
Calc_Speed:
    push Acc
    Calc_Speed_Mul:
        mov A, #WHEEL_C_DEC
        mov B, #6EH
        mul AB
        mov speed_int_l, A
        mov speed_int_m, B
        mov A, #WHEEL_C_INT
        mov B, #6EH
        mul AB
        add A, speed_int_m
        mov speed_int_m, A
        mov A, #0
        addc A, B
    Calc_Speed_RR:
        clr C
        rrc A
        mov speed_int_h, A
        mov A, speed_int_m
        rrc A
        mov speed_int_m, A
        mov A, speed_int_l
        rrc A
        mov speed_int_l, A
        mov A, speed_dec
        rrc A
        mov speed_dec, A
    Calc_Speed_Div:
        mov R0, #speed_dec
        mov R1, #last_pulse_th0
        acall DIV_4_BY_2
    pop Acc
    ret
Calc_Speed_Test:
    lcall Display_Test
    mov last_pulse_tl0, #60H
    mov last_pulse_th0, #86H
    mov last_pulse, #64H
    lcall Calc_Speed
    lcall Bin2BCD
    ret
    
Calc_Speed_Test1:
    mov IP, #00000011B
    setb ET0
    setb EX0
    setb IT0
    lcall Display_Test
    setb TR0
    lcall Calc_Mile
    lcall Calc_Speed
    lcall Bin2BCD
    jmp $-9
    ret
{% endhighlight %}
</details>



## æ˜¾ç¤º

### äºŒè¿›åˆ¶è½¬å‹ç¼©BCD

<details>
{% highlight c linenos %}
;====================================================================
; äºŒè¿›åˆ¶è½¬å‹ç¼©BCD
;====================================================================
Bin2BCD:
    ;è½¬æ¢ä»·æ ¼
    mov A, price_int
    acall Bin2BCD_Int
    mov digit_price_h, A
    mov A, price_dec
    acall Bin2BCD_Dec
    mov digit_price_l, A
    setb digit_price_dot_1
    clr digit_price_dot_0
    ;è½¬æ¢é‡Œç¨‹
    mov A, mile_int_l
    acall Bin2BCD_Int
    mov digit_mile_h, A
    mov A, mile_dec
    acall Bin2BCD_Dec
    mov digit_mile_l, A
    setb digit_mile_dot_1
    clr digit_mile_dot_0
    ;è½¬æ¢é€Ÿåº¦
    mov A, speed_int_l
    acall Bin2BCD_Int
    swap A
    push Acc
    anl A, #0FH
    mov R0, A
    mov A, B
    swap A
    orl A, R0
    mov digit_speed_h, A
    mov A, speed_dec
    acall Bin2BCD_Dec
    swap A
    anl A, #0FH
    mov R0, A
    pop Acc
    anl A, #0F0H
    orl A, R0
    mov digit_speed_l, A
    clr digit_speed_dot_1
    setb digit_speed_dot_0
    ret
Bin2BCD_Test:
    ; å¦‚æœç¨‹åºæ­£ç¡®ï¼Œæ˜¾ç¤º 10.50 10.50 010.5
    lcall Display_Test
    mov price_int, #0AH
    mov price_dec, #80H
    mov mile_int_l, #0AH
    mov mile_dec, #80H
    mov speed_int_l, #0AH
    mov speed_dec, #80H
    acall Bin2BCD
    ret

;====================================================================
; å•å­—èŠ‚äºŒè¿›åˆ¶è½¬å‹ç¼©BCD
;====================================================================
Bin2BCD_Int:
    ; å•å­—èŠ‚è½¬BCD
    ; å‚æ•°ï¼šA å¾…è½¬æ¢çš„å­—èŠ‚
    ; è¿”å›ï¼šA ä½å››ä½å’Œé«˜å››ä½åˆ†åˆ«å­˜æ”¾ä¸ªä½å’Œåä½ï¼ŒB ä½å››ä½å­˜æ”¾ç™¾ä½
    mov B, #100 ;100ä½œä¸ºé™¤æ•°é€å…¥Bä¸­
    div AB      ;16è¿›åˆ¶æ•°é™¤ä»¥100
    mov R1, A   ;ç™¾ä½æ•°é€R0ï¼Œä½™æ•°åœ¨Bä¸­
    mov A, #10  ;åˆ†ç¦»åä½æ•°å’Œä¸ªä½æ•°
    xch A, B    ;ä½™æ•°é€å…¥Aä¸­ï¼Œé™¤æ•°10æ”¾åœ¨Bä¸­
    div AB      ;åˆ†ç¦»å‡ºåä½æ”¾åœ¨Aä¸­ï¼Œå„ä½æ”¾åœ¨Bä¸­
    swap A      ;åä½äº¤æ¢åˆ°Açš„é«˜4ä½
    add A, B    ;å°†ä¸ªä½é€å…¥Açš„ä½4ä½
    mov B, R1   ;å°†ç™¾ä½é€å…¥B
    ret

Bin2BCD_Dec:
    ; å•å­—èŠ‚è½¬BCD
    ; å‚æ•°ï¼šA å¾…è½¬æ¢çš„å­—èŠ‚
    ; è¿”å›ï¼šA é«˜å››ä½å’Œä½å››ä½åˆ†åˆ«å­˜æ”¾ååˆ†ä½å’Œç™¾åˆ†ä½
    mov B, #10
    mul AB      ;16è¿›åˆ¶æ•°ä¹˜ä»¥10
    mov R1, B   ;ååˆ†ä½é€R0ï¼Œå‰©ä½™å°æ•°åœ¨Aä¸­
    mov B, #10
    mul AB
    mov A, B
    swap A      ;ç™¾åˆ†ä½äº¤æ¢åˆ°Açš„é«˜4ä½
    orl A, R1
    swap A      ;å°†ååˆ†ä½æ”¾åˆ°é«˜å››ä½ï¼Œç™¾åˆ†ä½æ”¾åˆ°ä½å››ä½
    ret
{% endhighlight %}
</details>

## å®šæ—¶å™¨ 0


<details>
{% highlight c linenos %}
;====================================================================
; è®¡æ—¶ï¼ˆå®šæ—¶å™¨0ï¼‰
;====================================================================
Timer:
    ;æ³¨ï¼šsetb TR0 åœ¨å‰é¢çš„ org 000BH åé¢
    push Acc
    push PSW
    inc this_pulse
    mov A, last_pulse
    clr C
    subb A, this_pulse ;æœ¬æ¬¡è„‰å†²é—´éš”è¶…è¿‡ä¸Šæ¬¡çš„æ—¶é—´ï¼Œè¯´æ˜é€Ÿåº¦å˜æ…¢äº†
    jnc Timer_Return
    setb zero_speed_bit ;ç›´æ¥æ˜¾ç¤º0
    ;ä¸‹é¢æ˜¯ä¸ç›´æ¥æ˜¾ç¤º0ï¼Œè€Œæ˜¯é€æ¸å‡å°åˆ°0
    ;åœ¨ä»¿çœŸæ—¶å‘ç°æ•ˆæœä¸å¥½ï¼Œä¾¿æ”¾å¼ƒ
    ;mov A, #1
    ;add A, last_pulse_th0
    ;mov last_pulse_th0, A
    ;jnc Timer_Return
    ;inc last_pulse
    ;mov A, last_pulse
    ;cjne A, #090H, pulse_Return
    ;Timer_Clr_Speed:
    ;    mov last_pulse, #090H
    Timer_Return:
        pop PSW
        pop Acc
        reti
{% endhighlight %}
</details>

## å®šæ—¶å™¨ 1

<details>
{% highlight c linenos %}
;====================================================================
; æ˜¾ç¤ºï¼ˆå®šæ—¶å™¨1ï¼‰
;====================================================================
Display:
    ; æ ¹æ® digit_speed, digit_price, digit_mile ä¸­çš„å‹ç¼©BCDæ¥æ˜¾ç¤º
    ; æ ¹æ® digit_speed_dot, digit_price_dot, digit_mile_dot æ¥æ˜¾ç¤ºå°æ•°ç‚¹
    push Acc
    push PSW
    mov DPTR, #LED_SEGMENT_CODE
    
    Display_Price:

    mov A, digit_price_h
    swap A
    anl A, #0FH
    movc A, @A+DPTR
    mov P1, #0
    mov P2, #0
    mov P1, A
    mov C, digit_price_dot_0
    anl C, digit_price_dot_1
    nop
    mov P1.7, C

    mov A, digit_price_h
    anl A, #0FH
    movc A, @A+DPTR
    mov P1, #0
    mov P2, #1
    mov P1, A
    mov C, digit_price_dot_0
    cpl C
    anl C, digit_price_dot_1
    mov P1.7, C

    mov A, digit_price_l
    swap A
    anl A, #0FH
    movc A, @A+DPTR
    mov P1, #0
    mov P2, #2
    mov P1, A
    mov C, digit_price_dot_1
    cpl C
    anl C, digit_price_dot_0
    mov P1.7, C
    
    mov A, digit_price_l
    anl A, #0FH
    movc A, @A+DPTR
    mov P1, #0
    mov P2, #3
    mov P1, A
    mov C, digit_price_dot_1
    orl C, digit_price_dot_0
    cpl C
    mov P1.7, C

    Display_Mile:
    mov A, digit_mile_h
    swap A
    anl A, #0FH
    movc A, @A+DPTR
    mov P1, #0
    mov P2, #4
    mov P1, A
    mov C, digit_price_dot_0
    anl C, digit_price_dot_1
    nop
    mov P1.7, C

    mov A, digit_mile_h
    anl A, #0FH
    movc A, @A+DPTR
    mov P1, #0
    mov P2, #5
    mov P1, A
    mov C, digit_mile_dot_0
    cpl C
    anl C, digit_mile_dot_1
    mov P1.7, C

    mov A, digit_mile_l
    swap A
    anl A, #0FH
    movc A, @A+DPTR
    mov P1, #0
    mov P2, #6
    mov P1, A
    mov C, digit_mile_dot_1
    cpl C
    anl C, digit_mile_dot_0
    mov P1.7, C

    mov A, digit_mile_l
    anl A, #0FH
    movc A, @A+DPTR
    mov P1, #0
    mov P2, #7
    mov P1, A
    mov C, digit_mile_dot_1
    orl C, digit_mile_dot_0
    cpl C
    mov P1.7, C

    Display_Speed:
    jnb zero_speed_bit, Display_Speed_Normal
    mov digit_speed_h, #0
    mov digit_speed_l, #0
    Display_Speed_Normal:
    mov A, digit_speed_h
    swap A
    anl A, #0FH
    movc A, @A+DPTR
    mov P1, #0
    mov P2, #8
    mov P1, A
    mov C, digit_speed_dot_0
    anl C, digit_speed_dot_1
    nop
    mov P1.7, C

    mov A, digit_speed_h
    anl A, #0FH
    movc A, @A+DPTR
    mov P1, #0
    mov P2, #9
    mov P1, A
    mov C, digit_speed_dot_0
    cpl C
    anl C, digit_speed_dot_1
    mov P1.7, C

    mov A, digit_speed_l
    swap A
    anl A, #0FH
    movc A, @A+DPTR
    mov P1, #0
    mov P2, #10
    mov P1, A
    mov C, digit_speed_dot_1
    cpl C
    anl C, digit_speed_dot_0
    mov P1.7, C

    mov A, digit_speed_l
    anl A, #0FH
    movc A, @A+DPTR
    mov P1, #0
    mov P2, #11
    mov P1, A
    mov C, digit_speed_dot_1
    orl C, digit_speed_dot_0
    cpl C
    mov P1.7, C

    Display_Return:
    pop PSW
    pop Acc
    mov P1, #0
    reti

;====================================================================
; æ˜¾ç¤ºæµ‹è¯•
;====================================================================
Display_Test:
    ; å¦‚æœç¨‹åºæ­£ç¡®ï¼Œä¼šæ˜¾ç¤º 12.34 23.45 345.6
    clr EA
    mov TMOD, #00100001B
    mov digit_price_h, #12H
    mov digit_price_l, #34H
    mov digit_mile_h, #23H
    mov digit_mile_l, #45H
    mov digit_speed_h, #34H
    mov digit_speed_l, #56H
    mov digit_dot, #00011010B
    setb ET1
    setb TR1
    setb EA
    ret
{% endhighlight %}
</details>

## å¤–éƒ¨ä¸­æ–­ 0

<details>
{% highlight c linenos %}
;====================================================================
; è„‰å†²ï¼ˆå¤–éƒ¨ä¸­æ–­0ï¼‰
;====================================================================
Pulse:
    push Acc
    push PSW ;2MC
    mov last_pulse_tl0, tl0 ;2MC
    mov last_pulse_th0, th0 ;2MC
    mov last_pulse, this_pulse ;2MC
    mov tl0, #16 ;éœ€è¦åŠ ä¸Šæ‰§è¡ŒæŒ‡ä»¤å ç”¨çš„æ—¶é—´ ;2MC 
    mov th0, #0 ;2MC
    setb TR0 ;1MC
    mov this_pulse, #0
    ;æ—¶é—´çš„å››èˆäº”å…¥
    mov A, #80H
    add A, last_pulse_tl0
    mov A, last_pulse_th0
    addc A, #0
    mov last_pulse_th0, A
    clr zero_speed_bit
    ;å¢åŠ æ€»è„‰å†²æ•°
    inc total_pulse_l
    mov A, total_pulse_l
    cjne A, #0, Pulse_Return
    inc total_pulse_h
    ; TODO: å¤„ç†æ€»è„‰å†²æ¬¡æ•°æº¢å‡º
    Pulse_Return:
        pop PSW
        pop Acc
        reti
{% endhighlight %}
</details>

# è¯¯å·®åˆ†æ

é€‰å–ä¸åŒçš„è„‰å†²é¢‘ç‡ï¼Œè®¡ç®—é€Ÿåº¦çš„ç†è®ºå€¼ï¼Œå¹¶ä¸å®é™…æ˜¾ç¤ºçš„å€¼ç›¸æ¯”è¾ƒï¼š

|è„‰å†²é¢‘ç‡ï¼ˆHzï¼‰|ç†è®ºå€¼|æ˜¾ç¤ºå€¼|è¯¯å·®|
|:-------:|:----:|:------:|:----:|
|1|6.588|6.5|1.34%|
|3|19.764|19.7|0.32%|
|5|32.94|32.9|0.12%|
|7|46.116|46.1|0.035%|
|9|59.292|59.3|0.013%|
|11|72.468|72.5|0.044%|
|13|85.644|85.8|0.18%|
|15|98.82|99|0.18%|
|17|111.996|111.9|0.085%|
|19|125.172|124.9|0.22%|

æ³¨æ„åˆ°æœ€å¤§çš„è¯¯å·®ä»…ä¸º 1.34%ï¼Œåœ¨æ¥å—èŒƒå›´å†…ã€‚

---

é€‰å–ä¸åŒé‡Œç¨‹ï¼Œè®¡ç®—ä»·æ ¼çš„ç†è®ºå€¼ï¼Œå¹¶ä¸å®é™…æ˜¾ç¤ºçš„å€¼ç›¸æ¯”è¾ƒï¼š

|è·¯ç¨‹|ç†è®ºå€¼|æ˜¾ç¤ºå€¼|è¯¯å·®|
|:-------:|:----:|:------:|:----:|
|2.38|8.98|8.99|0.11%|
|5.59|17.334|17.34|0.034%|
|9.92|28.592|28.57|0.077%|
|13.33|37.458|37.45|0.021%|
|19.95|54.67|54.63|0.055%|
|28.55|77.03|76.96|0.091%|
|33.21|89.146|89.09|0.063%|
# æ€»ä»£ç 

<details>
{% highlight c linenos %}
;====================================================================
; Main.asm file generated by New Project wizard
;
; Created:   å‘¨äºŒ 6æœˆ 8 2021
; Processor: AT89C51
; Compiler:  ASEM-51 (Proteus)
;====================================================================

$NOMOD51
$INCLUDE (8051.MCU)

;====================================================================
; DEFINITIONS
;====================================================================

MILE_THRESHOLD EQU 2H ;èµ·æ­¥ä»·çš„å…¬é‡Œ
START_PRICE EQU 8H ;èµ·æ­¥ä»·
MILE_PRICE_INT EQU 2H ;æ¯å…¬é‡Œä»·æ ¼çš„æ•´æ•°
MILE_PRICE_DEC EQU 99H ;æ¯å…¬é‡Œä»·æ ¼çš„å°æ•°
WHEEL_C_INT EQU 1H ;è½®èƒå‘¨é•¿çš„æ•´æ•°
WHEEL_C_DEC EQU 0D4H ;è½®èƒå‘¨é•¿çš„å°æ•°

;====================================================================
; VARIABLES
;====================================================================

; Pulse Interval
last_pulse_tl0 EQU 30H ;ä¸Šä¸ªè„‰å†²çš„é—´éš” ä½å­—èŠ‚ï¼ˆå³è®¡æ—¶å™¨çš„tl0)
last_pulse_th0 EQU 31H ;ä¸Šä¸ªè„‰å†²çš„é—´éš” ä¸­å­—èŠ‚ï¼ˆå³è®¡æ—¶å™¨çš„th0)
last_pulse EQU 32H ;ä¸Šä¸ªè„‰å†²çš„é—´éš” é«˜å­—èŠ‚ï¼ˆå³è®¡æ—¶å™¨çš„æº¢å‡ºæ¬¡æ•°ï¼‰
this_pulse EQU 33H ;æœ¬æ¬¡è„‰å†²çš„é—´éš” é«˜å­—èŠ‚

; Total Number of Pulses
total_pulse_l EQU 34H ;æ€»è„‰å†²æ•° ä½
total_pulse_h EQU 35H ;æ€»è„‰å†²æ•° é«˜

; Speed
speed_dec EQU 36H ;é€Ÿåº¦ å°æ•°
speed_int_l EQU 37H ;é€Ÿåº¦ æ•´æ•° ä½
speed_int_m EQU 38H ;é€Ÿåº¦ æ•´æ•° ä¸­
speed_int_h EQU 39H ;é€Ÿåº¦ æ•´æ•° é«˜


; Price
price_dec EQU 40H ;ä»·æ ¼ å°æ•°
price_int EQU 41H ;ä»·æ ¼ æ•´æ•°

; Mile
mile_dec EQU 42H ;é‡Œç¨‹ å°æ•°
mile_int_l EQU 43H ;é‡Œç¨‹ æ•´æ•° ä½
mile_int_m EQU 44H ;é‡Œç¨‹ æ•´æ•° ä¸­
mile_int_h EQU 45H ;é‡Œç¨‹ æ•´æ•° é«˜

; km
mile_km_l EQU 46H ;1000m ä½å­—èŠ‚
mile_km_h EQU 47H ;1000m é«˜å­—èŠ‚

; Divide Calculation
c_bit EQU 06H ;ç”¨äºä¿å­˜ C çš„çŠ¶æ€
remainder_l EQU 58H ;ä½™æ•° ä½
remainder_h EQU 59H ;ä½™æ•° é«˜

; Display
digit_dot EQU 20H ;å°æ•°ç‚¹ä½ç½®è®¾ç½®
digit_price_dot_0 EQU 00H ;ä»·æ ¼çš„å°æ•°ç‚¹ä½ç½® bit
digit_price_dot_1 EQU 01H
digit_mile_dot_0 EQU 02H ;é‡Œç¨‹çš„å°æ•°ç‚¹ä½ç½® bit
digit_mile_dot_1 EQU 03H
digit_speed_dot_0 EQU 04H ;é€Ÿåº¦çš„å°æ•°ç‚¹ä½ç½® bit
digit_speed_dot_1 EQU 05H
;c_bit EQU 06H
zero_speed_bit EQU 07H ;å¼ºåˆ¶é€Ÿåº¦æ˜¾ç¤º 0 çš„æ ‡å¿—ä½
digit_price_l EQU  5AH ;ä»·æ ¼ ä½2ä¸ªBCD 
digit_price_h EQU 5BH ;ä»·æ ¼ é«˜2ä¸ªBCD
digit_mile_l EQU 5CH ;é‡Œç¨‹ ä½2ä¸ªBCD 
digit_mile_h EQU 5DH ;é‡Œç¨‹ é«˜2ä¸ªBCD
digit_speed_l EQU 5EH ;é€Ÿåº¦ ä½2ä¸ªBCD 
digit_speed_h EQU 5FH ;é€Ÿåº¦ é«˜2ä¸ªBCD

; Run Bit
run_bit EQU 08H ;è¿è¡Œæ ‡å¿—ä½

;====================================================================
; RESET and INTERRUPT VECTORS
;====================================================================

    ; Reset Vector
    org   0000H
    jmp   Start

    org   0003H
    clr TR0 ;ä¸ºæé«˜å‡†ç¡®ç‡ï¼Œå…ˆæš‚åœå†è·³è½¬ ;1MC ;MCè¡¨ç¤ºæœºå™¨å‘¨æœŸ
    ljmp   Pulse ;2MC

    org   000BH
    setb  TR0 ;ä¸ºæé«˜å‡†ç¡®ç‡ï¼Œç«‹å³å¼€å§‹ä¸‹æ¬¡è®¡æ—¶
    ljmp  Timer

    org   001Bh
    ljmp  Display

;====================================================================
; CODE SEGMENT
;====================================================================

    org   0100h

LED_SEGMENT_CODE:
    db 3FH, 06H, 5BH, 4FH, 66H, 6DH, 7DH, 07H, 7FH, 6FH ;æ•°ç ç®¡0~9

Start:
    mov SP, #5FH
    mov IP, #00000011B
    mov TMOD, #00100001B
    mov digit_dot, #00011010B
    setb zero_speed_bit
    setb ET0
    setb ET1
    setb EX0
    setb IT0
    setb TR1
    setb TR0
    setb EA
Loop:
    lcall Calc_Speed ;æ— è®ºæœ‰æ— æŒ‰ä¸‹æŒ‰é”®ï¼Œå‡æ˜¾ç¤ºé€Ÿåº¦
    lcall Bin2BCD ;è½¬åŒ–ä¸ºBCDï¼Œç”¨äºæ˜¾ç¤º
    jb P3.7, Button_Not_Pressed ;æŒ‰é”®æ²¡æœ‰æŒ‰ä¸‹
    jb run_bit, Button_Pressed ;æŒ‰é”®æŒ‰ä¸‹ï¼Œä¸”ä¸Šä¸€æ—¶åˆ»ä¹ŸæŒ‰ä¸‹
    ;æŒ‰é”®ä»æœªæŒ‰ä¸‹åˆ°æŒ‰ä¸‹ï¼Œæ¸…é›¶é‡Œç¨‹ï¼Œå¹¶å¼€å§‹è®¡è´¹
    mov total_pulse_l, #0
    mov total_pulse_h, #0
    setb run_bit ;è®¾ç½®run_bit
    Button_Pressed:
        lcall Calc_Mile ;è®¡ç®—é‡Œç¨‹
        lcall Calc_Price ;è®¡ç®—ä»·æ ¼
        jmp Loop
    Button_Not_Pressed:
        clr run_bit ;æ¸…é™¤ run_bit
        jmp Loop ;å½“å‰å€¼ä¸å˜ï¼Œç›´æ¥å¾ªç¯



;====================================================================
; äºŒè¿›åˆ¶è½¬å‹ç¼©BCD
;====================================================================
Bin2BCD:
    ;è½¬æ¢ä»·æ ¼
    mov A, price_int
    acall Bin2BCD_Int
    mov digit_price_h, A
    mov A, price_dec
    acall Bin2BCD_Dec
    mov digit_price_l, A
    setb digit_price_dot_1
    clr digit_price_dot_0
    ;è½¬æ¢é‡Œç¨‹
    mov A, mile_int_l
    acall Bin2BCD_Int
    mov digit_mile_h, A
    mov A, mile_dec
    acall Bin2BCD_Dec
    mov digit_mile_l, A
    setb digit_mile_dot_1
    clr digit_mile_dot_0
    ;è½¬æ¢é€Ÿåº¦
    mov A, speed_int_l
    acall Bin2BCD_Int
    swap A
    push Acc
    anl A, #0FH
    mov R0, A
    mov A, B
    swap A
    orl A, R0
    mov digit_speed_h, A
    mov A, speed_dec
    acall Bin2BCD_Dec
    swap A
    anl A, #0FH
    mov R0, A
    pop Acc
    anl A, #0F0H
    orl A, R0
    mov digit_speed_l, A
    clr digit_speed_dot_1
    setb digit_speed_dot_0
    ret
;====================================================================
; äºŒè¿›åˆ¶è½¬å‹ç¼©BCDæµ‹è¯•
;====================================================================
Bin2BCD_Test:
    ; å¦‚æœç¨‹åºæ­£ç¡®ï¼Œæ˜¾ç¤º 10.50 10.50 010.5
    lcall Display_Test
    mov price_int, #0AH
    mov price_dec, #80H
    mov mile_int_l, #0AH
    mov mile_dec, #80H
    mov speed_int_l, #0AH
    mov speed_dec, #80H
    acall Bin2BCD
    ret

;====================================================================
; å•å­—èŠ‚äºŒè¿›åˆ¶è½¬å‹ç¼©BCD
;====================================================================
Bin2BCD_Int:
    ; å•å­—èŠ‚è½¬BCD
    ; å‚æ•°ï¼šA å¾…è½¬æ¢çš„å­—èŠ‚
    ; è¿”å›ï¼šA ä½å››ä½å’Œé«˜å››ä½åˆ†åˆ«å­˜æ”¾ä¸ªä½å’Œåä½ï¼ŒB ä½å››ä½å­˜æ”¾ç™¾ä½
    mov B, #100 ;100ä½œä¸ºé™¤æ•°é€å…¥Bä¸­
    div AB      ;16è¿›åˆ¶æ•°é™¤ä»¥100
    mov R1, A   ;ç™¾ä½æ•°é€R0ï¼Œä½™æ•°åœ¨Bä¸­
    mov A, #10  ;åˆ†ç¦»åä½æ•°å’Œä¸ªä½æ•°
    xch A, B    ;ä½™æ•°é€å…¥Aä¸­ï¼Œé™¤æ•°10æ”¾åœ¨Bä¸­
    div AB      ;åˆ†ç¦»å‡ºåä½æ”¾åœ¨Aä¸­ï¼Œå„ä½æ”¾åœ¨Bä¸­
    swap A      ;åä½äº¤æ¢åˆ°Açš„é«˜4ä½
    add A, B    ;å°†ä¸ªä½é€å…¥Açš„ä½4ä½
    mov B, R1   ;å°†ç™¾ä½é€å…¥B
    ret

Bin2BCD_Dec:
    ; å•å­—èŠ‚è½¬BCD
    ; å‚æ•°ï¼šA å¾…è½¬æ¢çš„å­—èŠ‚
    ; è¿”å›ï¼šA é«˜å››ä½å’Œä½å››ä½åˆ†åˆ«å­˜æ”¾ååˆ†ä½å’Œç™¾åˆ†ä½
    mov B, #10
    mul AB      ;16è¿›åˆ¶æ•°ä¹˜ä»¥10
    mov R1, B   ;ååˆ†ä½é€R0ï¼Œå‰©ä½™å°æ•°åœ¨Aä¸­
    mov B, #10
    mul AB
    mov A, B
    swap A      ;ç™¾åˆ†ä½äº¤æ¢åˆ°Açš„é«˜4ä½
    orl A, R1
    swap A      ;å°†ååˆ†ä½æ”¾åˆ°é«˜å››ä½ï¼Œç™¾åˆ†ä½æ”¾åˆ°ä½å››ä½
    ret

;====================================================================
; è®¡ç®—ä»·æ ¼
;====================================================================
Calc_Price:
    push Acc
    Calc_Price_If_Zero:
        mov A, mile_int_l
        cjne A, #0, Calc_Price_If
        mov A, mile_dec
        cjne A, #0, Calc_Price_If
        mov price_dec, #0
        mov price_int, #0
        jmp Calc_Price_Return
    Calc_Price_If:
        mov A, mile_int_l
        clr C
        subb A, #MILE_THRESHOLD
        jnc Calc_Price_Larger ;è‹¥é‡Œç¨‹çš„æ•´æ•°éƒ¨åˆ†å¤§äºç­‰äºèµ·æ­¥é‡Œç¨‹åˆ™è·³è½¬
    Calc_Price_Less:
        mov price_dec, #0
        mov price_int, #START_PRICE
        jmp Calc_Price_Return
    Calc_Price_Larger:
        push Acc ;ä¿å­˜ç›¸å‡åçš„ç»“æœ
        ;å¤šå‡ºæ¥çš„æ•´æ•°xæ¯å…¬é‡Œä»·æ ¼çš„å°æ•°éƒ¨åˆ†
        mov B, #MILE_PRICE_DEC
        mul AB 
        mov price_dec, A
        mov price_int, B
        ;å¤šå‡ºæ¥çš„æ•´æ•°xæ¯å…¬é‡Œä»·æ ¼çš„æ•´æ•°éƒ¨åˆ†
        pop Acc
        mov B, #MILE_PRICE_INT
        mul AB
        add A, price_int
        mov price_int, A
        ; TODO: å¤„ç† B!=0 çš„æƒ…å†µ
        mov A, mile_dec
        mov B, #MILE_PRICE_INT
        mul AB
        add A, price_dec
        mov price_dec, A
        mov A, price_int
        addc A, B
        mov price_int, A
        mov A, mile_dec
        mov B, #MILE_PRICE_DEC
        mul AB
        xch A, B
        add A, price_dec
        mov price_dec, A
        mov A, #START_PRICE
        addc A, price_int
        mov price_int, A
    Calc_Price_Return:
        pop Acc
        ret
;====================================================================
; è®¡ç®—ä»·æ ¼æµ‹è¯•
;====================================================================
Calc_Price_Test:
    ; è‹¥ç¨‹åºæ­£ç¡®ï¼Œåº”è¯¥ä¼šæ˜¾ç¤º 11.9 å…ƒ
    lcall Display_Test
    mov mile_int_l, #3
    mov mile_dec, #80H
    lcall Calc_Price
    lcall Bin2BCD
    ret

;====================================================================
; è®¡ç®—é‡Œç¨‹
;====================================================================
Calc_Mile:
    push Acc
    Calc_Mile_Mul:
        mov A, #WHEEL_C_DEC
        mov B, total_pulse_l
        mul AB
        mov mile_dec, A
        mov mile_int_l, B
        mov A, #WHEEL_C_INT
        mov B, total_pulse_l
        mul AB
        add A, mile_int_l
        mov mile_int_l, A
        mov A, #0
        addc A, B
        mov mile_int_m, A
        mov A, #WHEEL_C_DEC
        mov B, total_pulse_h
        mul AB
        add A, mile_int_l
        mov mile_int_l, A
        mov A, mile_int_m
        addc A, B
        mov mile_int_m, A
        jnc $+4
        inc mile_int_h
        mov A, #WHEEL_C_INT
        mov B, total_pulse_h
        mul AB
        add A, mile_int_m
        mov mile_int_m, A
        mov A, mile_int_h
        addc A, B
        mov mile_int_h, A
    Calc_Mile_Div:
        mov mile_km_l, #0E8H
        mov mile_km_h, #03H
        mov R0, #mile_dec
        mov R1, #mile_km_l
        acall DIV_4_BY_2
    pop Acc
    ret
;====================================================================
; è®¡ç®—é‡Œç¨‹æµ‹è¯•
;====================================================================
Calc_Mile_Test:
    ; å¦‚æœç¨‹åºæ­£ç¡®ï¼Œåº”è¯¥ä¼šæ˜¾ç¤º 1 km
    lcall Display_Test
    mov total_pulse_l, #22H
    mov total_pulse_h, #02H
    lcall Calc_Mile
    lcall Bin2BCD
    ret

;====================================================================
; è®¡ç®—é€Ÿåº¦
;====================================================================
Calc_Speed:
    push Acc
    Calc_Speed_Mul:
        mov A, #WHEEL_C_DEC
        mov B, #6EH
        mul AB
        mov speed_int_l, A
        mov speed_int_m, B
        mov A, #WHEEL_C_INT
        mov B, #6EH
        mul AB
        add A, speed_int_m
        mov speed_int_m, A
        mov A, #0
        addc A, B
    Calc_Speed_RR:
        clr C
        rrc A
        mov speed_int_h, A
        mov A, speed_int_m
        rrc A
        mov speed_int_m, A
        mov A, speed_int_l
        rrc A
        mov speed_int_l, A
        mov A, speed_dec
        rrc A
        mov speed_dec, A
    Calc_Speed_Div:
        mov R0, #speed_dec
        mov R1, #last_pulse_th0
        acall DIV_4_BY_2
    pop Acc
    ret
;====================================================================
; è®¡ç®—é€Ÿåº¦æµ‹è¯•ä¸€
;====================================================================
Calc_Speed_Test:
    lcall Display_Test
    mov last_pulse_tl0, #60H
    mov last_pulse_th0, #86H
    mov last_pulse, #64H
    lcall Calc_Speed
    lcall Bin2BCD
    ret
;====================================================================
; è®¡ç®—é€Ÿåº¦æµ‹è¯•äºŒ
;====================================================================
Calc_Speed_Test1:
    mov IP, #00000011B
    setb ET0
    setb EX0
    setb IT0
    lcall Display_Test
    setb TR0
    lcall Calc_Mile
    lcall Calc_Speed
    lcall Bin2BCD
    jmp $-9
    ret

;====================================================================
; é™¤æ³•è¿ç®—ï¼ˆ4ä½é™¤ä»¥2ä½ï¼‰
;====================================================================
DIV_4_BY_2:
    ;R0 å­˜ 4 å­—èŠ‚è¢«é™¤æ•°çš„ä½ä½åœ°å€ï¼ˆå°ç«¯ï¼‰
    ;R1 å­˜ 2 å­—èŠ‚é™¤æ•°çš„ä½ä½åœ°å€ï¼ˆå°ç«¯ï¼‰
    ;ç»“æœä¼šä¿å­˜åˆ°è¢«é™¤æ•°çš„ 3 ä¸ªå­—èŠ‚ä¸­
    ;éœ€è¦ç»™ remainder_l, remainder_h, c_bit åˆ†é…ç©ºé—´
    ;æˆ–è€…å¯ä»¥ç”¨ remainder_h EQU R3
    mov B, #32 ;å¾ªç¯æ¬¡æ•° ;4*8
    mov remainder_h, #0
    mov remainder_l, #0
    DIV_RLC:
        clr C ;æ¸…ç©º Cï¼Œä½¿å¾—å¾ªç¯ç§»ä½æ—¶æœ€ä½ä½ç§»å…¥çš„æ˜¯ 0

        ;å°†è¢«é™¤æ•°å·¦ç§»
        mov A, @R0 ;å–æœ€ä½ä½
        rlc A ;å¾ªç¯å·¦ç§»
        mov @R0, A ;ä¿å­˜æœ€ä½ä½

        inc R0 
        mov A, @R0 ;å–ä¸­é—´ä½
        rlc A ;å¾ªç¯å·¦ç§»
        mov @R0, A ;ä¿å­˜ä¸­é—´ä½

        inc R0 
        mov A, @R0 ;å–ä¸­é—´ä½
        rlc A ;å¾ªç¯å·¦ç§»
        mov @R0, A ;ä¿å­˜ä¸­é—´ä½

        inc R0
        mov A, @R0 ;å–æœ€é«˜ä½
        rlc A ;å¾ªç¯
        mov @R0, A ;ä¿å­˜æœ€é«˜ä½

        ;æ¢å¤ R0 ä¸ºæœ€ä½ä½
        mov c_bit, C
        dec R0
        dec R0
        dec R0
        mov C, c_bit

        ;æŠŠç§»å‡ºçš„æœ€é«˜ä½æ”¾å…¥ä½™æ•°
        mov A, remainder_l ;å–ä½™æ•°ä½ä½
        rlc A ;å¾ªç¯å·¦ç§»
        mov remainder_l, A;ä¿å­˜ä½ä½

        mov A, remainder_h ;å–ä½™æ•°é«˜ä½
        rlc A ;å¾ªç¯å·¦ç§»
        mov remainder_h, A;ä¿å­˜é«˜ä½

        mov c_bit, C ;ä¿å­˜ä½™æ•°ç§»å‡ºçš„æœ€é«˜ä½

        
    DIV_SUB:
        ;å¤šå­—èŠ‚å‡æ³•
        clr C
        mov A, remainder_l
        subb A, @R1 ;ä½ä½ç›¸å‡
        mov R7, A

        inc R1
        mov A, remainder_h
        subb A, @R1 ;é«˜ä½ç›¸å‡
        mov R6, A
        
        jb c_bit, DIV_INC ;c_bit ä¸º 1ï¼Œè‚¯å®šå¤Ÿå‡ï¼Œä¿å­˜ç›¸å‡åçš„ä½™æ•°
        jc DIV_CONTINUE ;c_bit ä¸º 0ï¼Œä¸” C=1ï¼Œä¸å¤Ÿå‡ï¼Œä¸ä¿å­˜ç›¸å‡çš„ç»“æœ
    DIV_INC:
        mov remainder_l, R7
        mov remainder_h, R6
        inc @R0
    DIV_CONTINUE:
        dec R1 ;æ¢å¤ R1 ä¸ºæœ€ä½ä½
        djnz B, DIV_RLC
        clr C
    DIV_RETURN:
        RET
;====================================================================
; é™¤æ³•è¿ç®—æµ‹è¯•
;====================================================================
DIV_4_BY_2_Test:
    ;å¦‚æœç¨‹åºæ­£ç¡®ï¼Œä¼šæ˜¾ç¤º 1.5
    lcall Display_Test
    mov mile_int_l, #1
    mov mile_dec, #80H
    mov mile_km_l, #1
    mov R0, #mile_dec
    mov R1, #mile_km_l
    acall DIV_4_BY_2
    lcall Bin2BCD
    ret
;====================================================================
; æ˜¾ç¤ºï¼ˆå®šæ—¶å™¨1ï¼‰
;====================================================================
Display:
    ; æ ¹æ® digit_speed, digit_price, digit_mile ä¸­çš„å‹ç¼©BCDæ¥æ˜¾ç¤º
    ; æ ¹æ® digit_speed_dot, digit_price_dot, digit_mile_dot æ¥æ˜¾ç¤ºå°æ•°ç‚¹
    push Acc
    push PSW
    mov DPTR, #LED_SEGMENT_CODE
    
    Display_Price: ;æ˜¾ç¤ºä»·æ ¼
    mov A, digit_price_h
    swap A
    anl A, #0FH
    movc A, @A+DPTR
    mov P1, #0
    mov P2, #0
    mov P1, A
    mov C, digit_price_dot_0
    anl C, digit_price_dot_1
    nop
    mov P1.7, C

    mov A, digit_price_h
    anl A, #0FH
    movc A, @A+DPTR
    mov P1, #0
    mov P2, #1
    mov P1, A
    mov C, digit_price_dot_0
    cpl C
    anl C, digit_price_dot_1
    mov P1.7, C

    mov A, digit_price_l
    swap A
    anl A, #0FH
    movc A, @A+DPTR
    mov P1, #0
    mov P2, #2
    mov P1, A
    mov C, digit_price_dot_1
    cpl C
    anl C, digit_price_dot_0
    mov P1.7, C
    
    mov A, digit_price_l
    anl A, #0FH
    movc A, @A+DPTR
    mov P1, #0
    mov P2, #3
    mov P1, A
    mov C, digit_price_dot_1
    orl C, digit_price_dot_0
    cpl C
    mov P1.7, C

    Display_Mile: ;æ˜¾ç¤ºé‡Œç¨‹
    mov A, digit_mile_h
    swap A
    anl A, #0FH
    movc A, @A+DPTR
    mov P1, #0
    mov P2, #4
    mov P1, A
    mov C, digit_price_dot_0
    anl C, digit_price_dot_1
    nop
    mov P1.7, C

    mov A, digit_mile_h
    anl A, #0FH
    movc A, @A+DPTR
    mov P1, #0
    mov P2, #5
    mov P1, A
    mov C, digit_mile_dot_0
    cpl C
    anl C, digit_mile_dot_1
    mov P1.7, C

    mov A, digit_mile_l
    swap A
    anl A, #0FH
    movc A, @A+DPTR
    mov P1, #0
    mov P2, #6
    mov P1, A
    mov C, digit_mile_dot_1
    cpl C
    anl C, digit_mile_dot_0
    mov P1.7, C

    mov A, digit_mile_l
    anl A, #0FH
    movc A, @A+DPTR
    mov P1, #0
    mov P2, #7
    mov P1, A
    mov C, digit_mile_dot_1
    orl C, digit_mile_dot_0
    cpl C
    mov P1.7, C

    Display_Speed: ;æ˜¾ç¤ºé€Ÿåº¦
    jnb zero_speed_bit, Display_Speed_Normal
    mov digit_speed_h, #0
    mov digit_speed_l, #0
    Display_Speed_Normal:
    mov A, digit_speed_h
    swap A
    anl A, #0FH
    movc A, @A+DPTR
    mov P1, #0
    mov P2, #8
    mov P1, A
    mov C, digit_speed_dot_0
    anl C, digit_speed_dot_1
    nop
    mov P1.7, C

    mov A, digit_speed_h
    anl A, #0FH
    movc A, @A+DPTR
    mov P1, #0
    mov P2, #9
    mov P1, A
    mov C, digit_speed_dot_0
    cpl C
    anl C, digit_speed_dot_1
    mov P1.7, C

    mov A, digit_speed_l
    swap A
    anl A, #0FH
    movc A, @A+DPTR
    mov P1, #0
    mov P2, #10
    mov P1, A
    mov C, digit_speed_dot_1
    cpl C
    anl C, digit_speed_dot_0
    mov P1.7, C

    mov A, digit_speed_l
    anl A, #0FH
    movc A, @A+DPTR
    mov P1, #0
    mov P2, #11
    mov P1, A
    mov C, digit_speed_dot_1
    orl C, digit_speed_dot_0
    cpl C
    mov P1.7, C

    Display_Return:
    pop PSW
    pop Acc
    mov P1, #0
    reti

;====================================================================
; æ˜¾ç¤ºæµ‹è¯•
;====================================================================
Display_Test:
    ; å¦‚æœç¨‹åºæ­£ç¡®ï¼Œä¼šæ˜¾ç¤º 12.34 23.45 345.6
    clr EA
    mov TMOD, #00100001B
    mov digit_price_h, #12H
    mov digit_price_l, #34H
    mov digit_mile_h, #23H
    mov digit_mile_l, #45H
    mov digit_speed_h, #34H
    mov digit_speed_l, #56H
    mov digit_dot, #00011010B
    setb ET1
    setb TR1
    setb EA
    ret

;====================================================================
; è„‰å†²ï¼ˆå¤–éƒ¨ä¸­æ–­0ï¼‰
;====================================================================
Pulse:
    push Acc
    push PSW ;2MC
    mov last_pulse_tl0, tl0 ;2MC
    mov last_pulse_th0, th0 ;2MC
    mov last_pulse, this_pulse ;2MC
    mov tl0, #16 ;éœ€è¦åŠ ä¸Šæ‰§è¡ŒæŒ‡ä»¤å ç”¨çš„æ—¶é—´ ;2MC 
    mov th0, #0 ;2MC
    setb TR0 ;1MC
    mov this_pulse, #0
    ;æ—¶é—´çš„å››èˆäº”å…¥
    mov A, #80H
    add A, last_pulse_tl0
    mov A, last_pulse_th0
    addc A, #0
    mov last_pulse_th0, A
    clr zero_speed_bit
    ;å¢åŠ æ€»è„‰å†²æ•°
    inc total_pulse_l
    mov A, total_pulse_l
    cjne A, #0, Pulse_Return
    inc total_pulse_h
    ; TODO: å¤„ç†æ€»è„‰å†²æ¬¡æ•°æº¢å‡º
    Pulse_Return:
        pop PSW
        pop Acc
        reti

;====================================================================
; è®¡æ—¶ï¼ˆå®šæ—¶å™¨0ï¼‰
;====================================================================
Timer:
    ;æ³¨ï¼šsetb TR0 åœ¨å‰é¢çš„ org 000BH åé¢
    push Acc
    push PSW
    inc this_pulse ;å¢åŠ æœ¬æ¬¡çš„æº¢å‡ºæ¬¡æ•°
    mov A, last_pulse
    clr C
    subb A, this_pulse ;æœ¬æ¬¡è„‰å†²é—´éš”è¶…è¿‡ä¸Šæ¬¡çš„æ—¶é—´ï¼Œè¯´æ˜é€Ÿåº¦å˜æ…¢äº†
    jnc Timer_Return
    setb zero_speed_bit ;ç›´æ¥æ˜¾ç¤º0
    ;ä¸‹é¢æ˜¯ä¸ç›´æ¥æ˜¾ç¤º0ï¼Œè€Œæ˜¯é€æ¸å‡å°åˆ°0
    ;åœ¨ä»¿çœŸæ—¶å‘ç°æ•ˆæœä¸å¥½ï¼Œä¾¿æ”¾å¼ƒ
    ;mov A, #1
    ;add A, last_pulse_th0
    ;mov last_pulse_th0, A
    ;jnc Timer_Return
    ;inc last_pulse
    ;mov A, last_pulse
    ;cjne A, #090H, pulse_Return
    ;Timer_Clr_Speed:
    ;    mov last_pulse, #090H
    Timer_Return:
        pop PSW
        pop Acc
        reti

;====================================================================
    END
{% endhighlight %}
</details>

# æ€»ç»“

&emsp;&emsp;ç­”è¾©ä¹‹åï¼Œè€å¸ˆè®¤ä¸ºæ—¢ç„¶é€Ÿåº¦çš„æ•°ç ç®¡å¯ä»¥æ˜¾ç¤º 100ï¼Œé‚£ä¹Ÿåº”è¯¥å¯ä»¥æ˜¾ç¤ºå¤§äº 255 çš„æ•°ï¼Œä½†æˆ‘è§‰å¾—å®é™…ä¸­ä¸å¯èƒ½å‡ºç°å¤§äº 255km/h çš„é€Ÿåº¦ã€‚è¿™æ˜¯å°é—®é¢˜ï¼Œåªéœ€è¦åˆ¤æ–­ä¸€ä¸‹ last_pulse æ˜¯å¦ä¸º0ï¼Œå¦‚æœä¸º0ï¼Œé‚£ä¹ˆå°±ä½¿ç”¨ last_pulse_tl0 å’Œ last_pulse_th0 æ¥ä½œä¸ºè¢«é™¤æ•°ï¼Œç„¶åæœ€åç»“æœå·¦ç§» 8 ä½å³å¯ã€‚

&emsp;&emsp;å¦å¤–ï¼Œè€å¸ˆè¯´å¯ä»¥è®¡ç®— 1s å†…çš„è„‰å†²æ•°æ¥è®¡ç®—é€Ÿåº¦ï¼Œè¿™æ ·ç¡®å®æ›´ç®€å•ï¼Œä½†æ˜¯å®æ—¶æ€§ä¸å¦‚æˆ‘çš„å®ç°æ–¹å¼ã€‚

&emsp;&emsp;æ€»ä¹‹ï¼Œè¿™æ¬¡å¤§ä½œä¸šç€å®è®©æˆ‘ä½“ä¼šåˆ°äº†åœ¨ 51 ä¸Šåšæ•°å­¦è¿ç®—çš„ç—›è‹¦ã€‚